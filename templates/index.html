<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Autocomplete Recommendation System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --color-indigo: #5e6ad2;
            --color-white: #fff;
            --color-black: #000;
            --color-text-primary: rgb(17, 24, 39);
            --color-text-secondary: rgb(75, 85, 99);
            --color-bg-primary: rgb(249, 250, 251);
            --color-bg-light: #F4F5F8;
            --font-regular: "Inter Variable", "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            --font-weight-normal: 400;
            --font-weight-medium: 510;
            --font-weight-semibold: 590;
            --radius-8: 8px;
            --radius-12: 12px;
            --radius-16: 16px;
        }

        body {
            font-family: var(--font-regular);
            background: var(--color-bg-primary);
            color: var(--color-text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1024px;
            margin: 0 auto;
            padding: 64px 24px;
        }

        .header {
            margin-bottom: 48px;
            text-align: center;
        }

        .header h1 {
            font-size: 40px;
            font-weight: 590;
            line-height: 44px;
            letter-spacing: -0.88px;
            color: var(--color-text-primary);
            margin-bottom: 12px;
        }

        .header p {
            font-size: 15px;
            font-weight: var(--font-weight-normal);
            line-height: 24px;
            color: var(--color-text-secondary);
        }

        .card {
            background: var(--color-white);
            border-radius: var(--radius-12);
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .card h2 {
            font-size: 1.5rem;
            font-weight: 590;
            line-height: 1.33;
            color: var(--color-text-primary);
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 510;
            color: var(--color-text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 10px 12px;
            font-family: var(--font-regular);
            font-size: 15px;
            font-weight: var(--font-weight-normal);
            line-height: 24px;
            color: var(--color-text-primary);
            background: var(--color-white);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--radius-8);
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }

        input[type="text"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--color-indigo);
            box-shadow: 0 0 0 2px rgba(94, 106, 210, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
            font-family: var(--font-regular);
        }

        button {
            font-family: var(--font-regular);
            font-size: 13px;
            font-weight: 510;
            color: var(--color-white);
            background: var(--color-indigo);
            border: none;
            padding: 10px 16px;
            border-radius: var(--radius-8);
            cursor: pointer;
            transition: background-color 0.15s ease, transform 0.1s ease;
        }

        button:hover {
            background: #4d5bc0;
        }

        button:active {
            transform: scale(0.98);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .results {
            margin-top: 32px;
            padding-top: 32px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        .results h3 {
            font-size: 1.25rem;
            font-weight: 590;
            line-height: 1.33;
            color: var(--color-text-primary);
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }

        .stat-card {
            background: var(--color-bg-light);
            padding: 20px;
            border-radius: var(--radius-8);
        }

        .stat-card-label {
            font-size: 13px;
            font-weight: 510;
            color: var(--color-text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card-value {
            font-size: 28px;
            font-weight: 590;
            line-height: 1.2;
            color: var(--color-text-primary);
        }

        .stat-card-value.small {
            font-size: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--color-text-secondary);
            font-size: 15px;
        }

        .error {
            background: rgba(235, 87, 87, 0.1);
            color: #c62828;
            padding: 16px;
            border-radius: var(--radius-8);
            margin-top: 20px;
            font-size: 14px;
            border-left: 3px solid #eb5757;
        }

        .success {
            background: rgba(76, 183, 130, 0.1);
            color: #2e7d32;
            padding: 16px;
            border-radius: var(--radius-8);
            margin-top: 20px;
            font-size: 14px;
            border-left: 3px solid #4cb782;
        }

        .profile-badge {
            display: inline-block;
            font-size: 12px;
            font-weight: 510;
            color: var(--color-indigo);
            background: rgba(94, 106, 210, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            margin-bottom: 16px;
        }

        .comparison-section {
            margin-top: 32px;
            padding-top: 32px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 20px;
        }

        .comparison-card {
            background: var(--color-bg-light);
            padding: 20px;
            border-radius: var(--radius-8);
        }

        .comparison-card h4 {
            font-size: 13px;
            font-weight: 510;
            color: var(--color-text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .comparison-value {
            font-size: 32px;
            font-weight: 590;
            line-height: 1.2;
            color: var(--color-text-primary);
        }

        .improvement {
            color: #4cb782;
            font-weight: 590;
        }

        .word-details {
            margin-top: 32px;
        }

        .word-details h3 {
            font-size: 1.25rem;
            font-weight: 590;
            line-height: 1.33;
            color: var(--color-text-primary);
            margin-bottom: 20px;
        }

        .word-item {
            background: var(--color-bg-light);
            padding: 16px;
            border-radius: var(--radius-8);
            margin-bottom: 12px;
            border-left: 3px solid var(--color-indigo);
        }

        .word-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .word-text {
            font-size: 16px;
            font-weight: 590;
            color: var(--color-text-primary);
        }

        .word-prefix {
            display: inline-block;
            background: var(--color-indigo);
            color: var(--color-white);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 510;
        }

        .romaji-text {
            font-size: 13px;
            color: var(--color-text-secondary);
            font-style: italic;
        }

        .word-stats {
            display: flex;
            gap: 16px;
            font-size: 13px;
            color: var(--color-text-secondary);
            margin-bottom: 12px;
        }

        .word-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .recommendations-list {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        .recommendations-label {
            font-size: 12px;
            font-weight: 510;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .recommendation-tag {
            display: inline-block;
            background: var(--color-white);
            border: 1px solid rgba(0, 0, 0, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 13px;
            margin-right: 6px;
            margin-bottom: 6px;
        }

        .recommendation-tag.selected {
            background: rgba(94, 106, 210, 0.1);
            border-color: var(--color-indigo);
            color: var(--color-indigo);
            font-weight: 510;
        }

        .savings-badge {
            display: inline-block;
            background: rgba(76, 183, 130, 0.1);
            color: #4cb782;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 510;
        }

        @media (max-width: 768px) {
            .container {
                padding: 32px 16px;
            }

            .header h1 {
                font-size: 32px;
                line-height: 36px;
            }

            .card {
                padding: 24px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .comparison-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Word Autocomplete Recommendation System</h1>
            <p>Analyze autocomplete efficiency by entering a sentence</p>
        </div>

        <div class="card">
            <h2>Sentence Test</h2>
            
            <div class="form-group">
                <label>Test Sentence</label>
                <div style="display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; align-items: center;">
                    <select id="sample-profile-select" style="padding: 6px 12px; font-size: 12px; border-radius: var(--radius-8); border: 1px solid rgba(0, 0, 0, 0.1); background: var(--color-white);">
                        <option value="general">General (Default Recommendation)</option>
                    </select>
                    <button 
                        type="button" 
                        onclick="loadSampleSentence()" 
                        style="background: var(--color-bg-light); color: var(--color-text-primary); border: 1px solid rgba(0, 0, 0, 0.1); padding: 6px 12px; font-size: 12px; border-radius: var(--radius-8); cursor: pointer; transition: background-color 0.15s ease;"
                        onmouseover="this.style.background='rgba(0,0,0,0.05)'"
                        onmouseout="this.style.background='var(--color-bg-light)'"
                    >
                        Load Sample Sentence
                    </button>
                    <button 
                        type="button" 
                        onclick="compareWithProfile()" 
                        style="background: var(--color-indigo); color: var(--color-white); border: none; padding: 6px 12px; font-size: 12px; border-radius: var(--radius-8); cursor: pointer; transition: background-color 0.15s ease;"
                        onmouseover="this.style.background='#4d5bc0'"
                        onmouseout="this.style.background='var(--color-indigo)'"
                    >
                        Compare Test
                    </button>
                </div>
                <textarea 
                    id="sentence-input" 
                    placeholder="e.g., I need to work on this project."
                    rows="4"
                ></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Language</label>
                    <select id="lang-select">
                        <option value="en">English</option>
                        <option value="it">Italian</option>
                        <option value="ja">Japanese</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>User Profile</label>
                    <select id="user-select">
                        <option value="">None (Default Recommendation)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Profile Language</label>
                    <select id="user-lang-select">
                        <option value="en">English</option>
                        <option value="it">Italian</option>
                        <option value="ja">Japanese</option>
                    </select>
                </div>
            </div>

            <button onclick="testSentence()">Run Test</button>

            <div id="results" class="results" style="display: none;"></div>
        </div>
    </div>

    <script>
        // 사용자 목록 로드
        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                const data = await response.json();
                if (data.success) {
                    const select = document.getElementById('user-select');
                    const firstOption = select.innerHTML;
                    select.innerHTML = firstOption;
                    
                    for (const [lang, users] of Object.entries(data.users)) {
                        const langName = lang === 'en' ? 'English' : lang === 'it' ? 'Italian' : 'Japanese';
                        users.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user;
                            option.textContent = `${user} (${langName})`;
                            option.dataset.lang = lang;
                            select.appendChild(option);
                        });
                    }
                    
                    // 샘플 프로필 선택 드롭다운에도 추가
                    const sampleSelect = document.getElementById('sample-profile-select');
                    sampleSelect.innerHTML = '<option value="general">General (Default Recommendation)</option>';
                    for (const [lang, users] of Object.entries(data.users)) {
                        const langName = lang === 'en' ? 'English' : lang === 'it' ? 'Italian' : 'Japanese';
                        users.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user;
                            option.textContent = `${user} (${langName})`;
                            option.dataset.lang = lang;
                            sampleSelect.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Failed to load user list:', error);
            }
        }

        // 문장 테스트
        async function testSentence() {
            const sentence = document.getElementById('sentence-input').value.trim();
            if (!sentence) {
                alert('Please enter a sentence.');
                return;
            }

            const lang = document.getElementById('lang-select').value;
            const userId = document.getElementById('user-select').value;
            const userLang = userId ? document.getElementById('user-lang-select').value : lang;

            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<div class="loading">Testing...</div>';

            try {
                const response = await fetch('/api/test-sentence', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sentence,
                        lang,
                        user_id: userId || null,
                        user_lang: userLang
                    })
                });

                const data = await response.json();
                if (data.success) {
                    const result = data.result;
                    let html = '';
                    
                    if (userId) {
                        html += `<div class="profile-badge">Personalized Recommendation Active: ${userId}</div>`;
                    }
                    
                    html += `
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-card-label">Word Count</div>
                                <div class="stat-card-value">${result.word_count}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-label">Savings Rate</div>
                                <div class="stat-card-value">${result.savings_rate.toFixed(2)}%</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-label">Chars Saved</div>
                                <div class="stat-card-value">${result.chars_saved}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-label">Input Chars</div>
                                <div class="stat-card-value small">${result.total_chars_with} / ${result.total_chars_without}</div>
                            </div>
                        </div>
                    `;
                    
                    // 단어별 상세 정보
                    if (result.word_details && result.word_details.length > 0) {
                        html += `
                            <div class="word-details">
                                <h3>Word Details</h3>
                        `;
                        
                        result.word_details.forEach((wordDetail, index) => {
                            const isSaved = wordDetail.chars_saved > 0;
                            const selectedWord = wordDetail.recommendations.find(r => 
                                r.word.toLowerCase() === wordDetail.word_lower
                            );
                            
                            html += `
                                <div class="word-item">
                                    <div class="word-header">
                                        <span class="word-text">${wordDetail.word}</span>
                                        ${wordDetail.romaji ? `<span class="romaji-text">(${wordDetail.romaji})</span>` : ''}
                                        <span class="word-prefix">${wordDetail.prefix}</span>
                                        ${wordDetail.prefix_romaji ? `<span class="romaji-text">(${wordDetail.prefix_romaji})</span>` : ''}
                                        ${isSaved ? `<span class="savings-badge">${wordDetail.chars_saved} chars saved</span>` : ''}
                                    </div>
                                    <div class="word-stats">
                                        <div class="word-stat">
                                            <span>Full:</span>
                                            <strong>${wordDetail.full_length} chars</strong>
                                        </div>
                                        <div class="word-stat">
                                            <span>Input:</span>
                                            <strong>${wordDetail.prefix_length} chars</strong>
                                        </div>
                                        <div class="word-stat">
                                            <span>Saved:</span>
                                            <strong>${wordDetail.chars_saved} chars</strong>
                                        </div>
                                    </div>
                                    ${wordDetail.recommendations.length > 0 ? `
                                        <div class="recommendations-list">
                                            <div class="recommendations-label">Recommended Words (when typing ${wordDetail.prefix}${wordDetail.prefix_romaji ? ` / ${wordDetail.prefix_romaji}` : ''})</div>
                                            ${wordDetail.recommendations.map(rec => {
                                                const isSelected = rec.word.toLowerCase() === wordDetail.word_lower;
                                                return `<span class="recommendation-tag ${isSelected ? 'selected' : ''}">${rec.word}</span>`;
                                            }).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        });
                        
                        html += `</div>`;
                    }
                    
                    resultsDiv.innerHTML = html;
                } else {
                    resultsDiv.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Enter 키로 테스트 실행 (Shift+Enter는 줄바꿈)
        document.getElementById('sentence-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                testSentence();
            }
        });

        // 샘플 문장 데이터 (언어별, 직업별)
        const sampleSentences = {
            en: {
                developer: [
                    "I need to work on this project.",
                    "The code is not working properly.",
                    "Let me check the function.",
                    "This function needs to be updated.",
                    "We should complete this project today.",
                    "The program needs to compile correctly.",
                    "I will finish this code tomorrow.",
                    "Can you help me with this function?",
                    "The class needs to be updated.",
                    "Let's work together on this project."
                ],
                writer: [
                    "The world was beautiful that day.",
                    "She thought about the story.",
                    "The character was very strong.",
                    "In this chapter, we see the change.",
                    "The words were wonderful.",
                    "The story begins with a beautiful scene.",
                    "She believed in the power of words.",
                    "The thought was still in her mind.",
                    "The chapter tells us about the character.",
                    "The world of the story was wonderful."
                ],
                business: [
                    "We need to work on this project.",
                    "The meeting is important for the client.",
                    "Let's complete the project today.",
                    "The company needs to update the process.",
                    "Please send me the document.",
                    "The meeting is scheduled for next week.",
                    "We should contact the client soon.",
                    "The project will help the company.",
                    "The price is important for the client.",
                    "We need to close this deal today."
                ],
                student: [
                    "I need to study for the exam.",
                    "The lesson is about the text.",
                    "I will learn this for the test.",
                    "The homework helps me understand.",
                    "The teacher explained the example.",
                    "I need to start studying now.",
                    "The lecture is very important.",
                    "I hope to pass the exam.",
                    "The exercise helps me learn.",
                    "The term is almost finished."
                ],
                general: [
                    "I want to learn new things.",
                    "The problem is very complex.",
                    "Let's start working together.",
                    "This is the best solution.",
                    "I need more information about this.",
                    "The day was very beautiful.",
                    "I think about this often.",
                    "The time has come for change.",
                    "This is a good idea.",
                    "I hope everything works well."
                ]
            },
            it: {
                developer: [
                    "Devo lavorare su questo progetto.",
                    "Il codice non funziona correttamente.",
                    "Lasciami controllare la funzione.",
                    "Questa funzione deve essere aggiornata.",
                    "Dovremmo completare questo oggi.",
                    "Il sistema deve essere aggiornato.",
                    "Finirò questo domani.",
                    "Puoi aiutarmi con questo codice?",
                    "Il programma non si compila.",
                    "Iniziamo a lavorare insieme su questo."
                ],
                writer: [
                    "Il mondo era bello quel giorno.",
                    "Lei pensava alla storia.",
                    "Il personaggio era molto forte.",
                    "In questo capitolo, vediamo il cambiamento.",
                    "Le parole erano meravigliose.",
                    "La storia inizia con una scena bella.",
                    "Lei credeva nel potere delle parole.",
                    "Il pensiero era ancora nella sua mente.",
                    "Il capitolo ci racconta del personaggio.",
                    "Il mondo della storia era meraviglioso."
                ],
                business: [
                    "Dobbiamo lavorare su questo progetto.",
                    "La riunione è importante per il cliente.",
                    "Completiamo il progetto oggi.",
                    "La compagnia deve aggiornare il processo.",
                    "Per favore inviami il documento.",
                    "La riunione è programmata per la prossima settimana.",
                    "Dovremmo contattare il cliente presto.",
                    "Il progetto aiuterà la compagnia.",
                    "Il prezzo è importante per il cliente.",
                    "Dobbiamo chiudere questo affare oggi."
                ],
                student: [
                    "Devo studiare per l'esame.",
                    "La lezione è sul testo.",
                    "Studierò questo per il test.",
                    "I compiti mi aiutano a capire.",
                    "L'insegnante ha spiegato l'esempio.",
                    "Devo iniziare a studiare ora.",
                    "La lezione è molto importante.",
                    "Spero di superare l'esame.",
                    "L'esercizio mi aiuta a imparare.",
                    "Il termine è quasi finito."
                ],
                general: [
                    "Voglio imparare cose nuove.",
                    "Il problema è molto complesso.",
                    "Iniziamo a lavorare insieme.",
                    "Questa è la soluzione migliore.",
                    "Ho bisogno di più informazioni su questo.",
                    "Il giorno era molto bello.",
                    "Penso spesso a questo.",
                    "È arrivato il momento del cambiamento.",
                    "Questa è una buona idea.",
                    "Spero che tutto funzioni bene."
                ]
            },
            ja: {
                developer: [
                    "このぷろじぇくとにとりくむひつようがあります。",
                    "こーどがただしくどうさしていません。",
                    "かんすうをかくにんさせてください。",
                    "このかんすうをこうしんするひつようがあります。",
                    "きょうこれをかんりょうすべきです。",
                    "しすてむをこうしんするひつようがあります。",
                    "あしたこれをおわらせます。",
                    "このこーどをてつだってもらえますか？",
                    "ぷろぐらむがこんぱいるされません。",
                    "これについていっしょにはたらきはじめましょう。"
                ],
                writer: [
                    "そのにちのせかいはうつくしかった。",
                    "かのじょはものがたりについてかんがえた。",
                    "きゃらくたーはひじょうにつよかった。",
                    "このしょうで、わたしたちはへんかをみます。",
                    "ことばはすばらしかった。",
                    "ものがたりはうつくしいしーんではじまります。",
                    "かのじょはことばのちからをしんじていました。",
                    "そのかんがえはまだかのじょのこころのなかにありました。",
                    "このしょうはきゃらくたーについてかたっています。",
                    "ものがたりのせかいはすばらしかった。"
                ],
                business: [
                    "このぷろじぇくとにとりくむひつようがあります。",
                    "かいぎはくらいあんとにとってじゅうようです。",
                    "きょうぷろじぇくとをかんりょうしましょう。",
                    "かいしゃはぷろせすをこうしんするひつようがあります。",
                    "どきゅめんとをおくってください。",
                    "かいぎはらいしゅうよていされています。",
                    "すぐにくらいあんとにれんらくすべきです。",
                    "ぷろじぇくとはかいしゃをたすけます。",
                    "かかくはくらいあんとにとってじゅうようです。",
                    "きょうこのとりひきをていけつするひつようがあります。"
                ],
                student: [
                    "しけんのためにべんきょうするひつようがあります。",
                    "じゅぎょうはてきすとについてです。",
                    "てすとのためにこれをまなびます。",
                    "しゅくだいはりかいをたすけます。",
                    "きょうしがれいをせつめいしました。",
                    "いますぐべんきょうをはじめるひつようがあります。",
                    "こうぎはひじょうにじゅうようです。",
                    "しけんにごうかくしたいです。",
                    "れんしゅうはがくしゅうをたすけます。",
                    "がっきはほぼおわりました。"
                ],
                general: [
                    "あたらしいことをまなびたいです。",
                    "もんだいはひじょうにふくざつです。",
                    "いっしょにはたらきはじめましょう。",
                    "これがさいりょうのかいけつさくです。",
                    "これについてもっとじょうほうがひつようです。",
                    "そのにちはとてもうつくしかった。",
                    "これについてよくかんがえます。",
                    "へんかのときがきました。",
                    "これはよいあいであです。",
                    "すべてがうまくいくことをねがっています。"
                ]
            }
        };

        // 샘플 문장 불러오기
        function loadSampleSentence() {
            // 현재 선택된 언어를 우선 사용
            let lang = document.getElementById('lang-select').value;
            const sampleProfile = document.getElementById('sample-profile-select').value;
            
            // 프로필이 선택된 경우, 프로필의 언어와 현재 선택된 언어를 확인
            if (sampleProfile !== 'general') {
                const option = document.getElementById('sample-profile-select').querySelector(`option[value="${sampleProfile}"]`);
                if (option && option.dataset.lang) {
                    const profileLang = option.dataset.lang;
                    // 프로필의 언어와 현재 선택된 언어가 다르면 프로필 언어로 변경
                    if (profileLang !== lang) {
                        lang = profileLang;
                        document.getElementById('lang-select').value = lang;
                    }
                }
            }
            
            // 사용자 ID에서 언어 접미사 제거 (예: "developer_en" -> "developer")
            const userType = sampleProfile === 'general' ? 'general' : sampleProfile.split('_')[0] || sampleProfile;
            
            // 선택한 언어의 샘플 문장 가져오기
            if (!sampleSentences[lang]) {
                alert(`No sample sentences available for the selected language (${lang === 'en' ? 'English' : lang === 'it' ? 'Italian' : 'Japanese'}).`);
                return;
            }
            
            const sentences = sampleSentences[lang][userType] || sampleSentences[lang].general || [];
            
            if (sentences.length > 0) {
                const randomSentence = sentences[Math.floor(Math.random() * sentences.length)];
                document.getElementById('sentence-input').value = randomSentence;
                
                // 프로필도 자동으로 설정
                if (sampleProfile !== 'general') {
                    document.getElementById('user-select').value = sampleProfile;
                    document.getElementById('user-lang-select').value = lang;
                } else {
                    document.getElementById('user-select').value = '';
                }
            } else {
                alert(`No sample sentences available for ${lang === 'en' ? 'English' : lang === 'it' ? 'Italian' : 'Japanese'}/${userType}.`);
            }
        }
        
        // 비교 테스트 (기본 추천 vs 개인화 추천)
        async function compareWithProfile() {
            const sentence = document.getElementById('sentence-input').value.trim();
            if (!sentence) {
                alert('Please enter a sentence.');
                return;
            }
            
            const lang = document.getElementById('lang-select').value;
            const sampleProfile = document.getElementById('sample-profile-select').value;
            
            if (sampleProfile === 'general') {
                alert('Please select a profile for comparison.');
                return;
            }
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<div class="loading">Running comparison test...</div>';
            
            try {
                // 기본 추천 테스트
                const generalResponse = await fetch('/api/test-sentence', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sentence,
                        lang,
                        user_id: null,
                        user_lang: lang
                    })
                });
                
                // 개인화 추천 테스트
                const option = document.getElementById('sample-profile-select').querySelector(`option[value="${sampleProfile}"]`);
                const profileLang = option ? (option.dataset.lang || lang) : lang;
                
                const personalizedResponse = await fetch('/api/test-sentence', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sentence,
                        lang,
                        user_id: sampleProfile,
                        user_lang: profileLang
                    })
                });
                
                const generalData = await generalResponse.json();
                const personalizedData = await personalizedResponse.json();
                
                if (generalData.success && personalizedData.success) {
                    const general = generalData.result;
                    const personalized = personalizedData.result;
                    
                    const improvement = personalized.savings_rate - general.savings_rate;
                    const improvementPercent = general.savings_rate > 0 
                        ? (improvement / general.savings_rate * 100).toFixed(2) 
                        : '0.00';
                    
                    let html = `
                        <h3>Comparison Result: Default vs Personalized Recommendation</h3>
                        <div class="profile-badge" style="margin-bottom: 20px;">Profile: ${sampleProfile}</div>
                        
                        <div class="comparison-grid" style="grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 24px;">
                            <div class="comparison-card">
                                <h4>Default Recommendation</h4>
                                <div class="comparison-value">${general.savings_rate.toFixed(2)}%</div>
                                <div style="margin-top: 12px; font-size: 13px; color: var(--color-text-secondary);">
                                    <div>Chars Saved: ${general.chars_saved}</div>
                                    <div>Input Chars: ${general.total_chars_with}</div>
                                </div>
                            </div>
                            <div class="comparison-card">
                                <h4>Personalized Recommendation</h4>
                                <div class="comparison-value" style="color: var(--color-indigo);">${personalized.savings_rate.toFixed(2)}%</div>
                                <div style="margin-top: 12px; font-size: 13px; color: var(--color-text-secondary);">
                                    <div>Chars Saved: ${personalized.chars_saved}</div>
                                    <div>Input Chars: ${personalized.total_chars_with}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 24px; padding: 16px; background: var(--color-bg-light); border-radius: var(--radius-8);">
                            <div style="font-size: 14px; color: var(--color-text-secondary); margin-bottom: 8px;">Improvement</div>
                            <div style="font-size: 24px; font-weight: 590; color: ${improvement > 0 ? '#4cb782' : improvement < 0 ? '#eb5757' : 'var(--color-text-primary)'};">
                                ${improvement > 0 ? '+' : ''}${improvement.toFixed(2)}%p
                                <span style="font-size: 14px; font-weight: 400; color: var(--color-text-secondary);">
                                    (${improvementPercent}% improvement)
                                </span>
                            </div>
                            <div style="margin-top: 8px; font-size: 13px; color: var(--color-text-secondary);">
                                Chars Saved Difference: ${personalized.chars_saved - general.chars_saved > 0 ? '+' : ''}${personalized.chars_saved - general.chars_saved} chars
                            </div>
                        </div>
                    `;
                    
                    // 단어별 차이 분석
                    if (general.word_details && personalized.word_details) {
                        const differences = [];
                        const maxLength = Math.max(general.word_details.length, personalized.word_details.length);
                        
                        for (let i = 0; i < maxLength; i++) {
                            const generalWord = general.word_details[i];
                            const personalizedWord = personalized.word_details[i];
                            
                            if (generalWord && personalizedWord) {
                                const prefixDiff = personalizedWord.prefix_length - generalWord.prefix_length;
                                const charsDiff = personalizedWord.chars_saved - generalWord.chars_saved;
                                
                                if (prefixDiff !== 0 || charsDiff !== 0) {
                                    differences.push({
                                        word: generalWord.word,
                                        wordRomaji: generalWord.romaji || null,
                                        generalPrefix: generalWord.prefix,
                                        generalPrefixRomaji: generalWord.prefix_romaji || null,
                                        generalPrefixLen: generalWord.prefix_length,
                                        personalizedPrefix: personalizedWord.prefix,
                                        personalizedPrefixRomaji: personalizedWord.prefix_romaji || null,
                                        personalizedPrefixLen: personalizedWord.prefix_length,
                                        prefixDiff: prefixDiff,
                                        charsDiff: charsDiff,
                                        generalRecommendations: generalWord.recommendations || [],
                                        personalizedRecommendations: personalizedWord.recommendations || []
                                    });
                                }
                            }
                        }
                        
                        if (differences.length > 0) {
                            html += `
                                <div style="margin-top: 32px; padding-top: 32px; border-top: 1px solid rgba(0, 0, 0, 0.05);">
                                    <h3 style="font-size: 1.25rem; font-weight: 590; margin-bottom: 20px;">Words with Differences</h3>
                            `;
                            
                            differences.forEach(diff => {
                                const isImproved = diff.prefixDiff < 0; // 접두사 길이가 짧아지면 개선
                                html += `
                                    <div class="word-item" style="margin-bottom: 16px;">
                                        <div class="word-header">
                                            <span class="word-text">${diff.word}</span>
                                            ${diff.wordRomaji ? `<span class="romaji-text">(${diff.wordRomaji})</span>` : ''}
                                            ${isImproved ? `<span class="savings-badge">${Math.abs(diff.charsDiff)} chars improved</span>` : ''}
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 12px;">
                                            <div>
                                                <div style="font-size: 12px; font-weight: 510; color: var(--color-text-secondary); margin-bottom: 8px; text-transform: uppercase;">Default Recommendation</div>
                                                <div style="font-size: 14px; color: var(--color-text-primary);">
                                                    Prefix: <strong>${diff.generalPrefix}</strong>${diff.generalPrefixRomaji ? ` <span class="romaji-text">(${diff.generalPrefixRomaji})</span>` : ''} (${diff.generalPrefixLen} chars)
                                                </div>
                                            </div>
                                            <div>
                                                <div style="font-size: 12px; font-weight: 510; color: var(--color-text-secondary); margin-bottom: 8px; text-transform: uppercase;">Personalized Recommendation</div>
                                                <div style="font-size: 14px; color: var(--color-indigo);">
                                                    Prefix: <strong>${diff.personalizedPrefix}</strong>${diff.personalizedPrefixRomaji ? ` <span class="romaji-text">(${diff.personalizedPrefixRomaji})</span>` : ''} (${diff.personalizedPrefixLen} chars)
                                                    ${isImproved ? '<span style="color: #4cb782;">✓</span>' : ''}
                                                </div>
                                            </div>
                                        </div>
                                        ${diff.personalizedRecommendations.length > 0 ? `
                                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0, 0, 0, 0.05);">
                                                <div style="font-size: 12px; font-weight: 510; color: var(--color-text-secondary); margin-bottom: 8px;">Personalized Recommendation Word List</div>
                                                ${diff.personalizedRecommendations.map(rec => {
                                                    const isSelected = rec.word.toLowerCase() === diff.word.toLowerCase();
                                                    return `<span class="recommendation-tag ${isSelected ? 'selected' : ''}">${rec.word}</span>`;
                                                }).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            });
                            
                            html += `</div>`;
                        } else {
                            html += `
                                <div style="margin-top: 32px; padding: 16px; background: var(--color-bg-light); border-radius: var(--radius-8); text-align: center; color: var(--color-text-secondary);">
                                    All words require the same prefix length.
                                </div>
                            `;
                        }
                    }
                    
                    resultsDiv.innerHTML = html;
                } else {
                    resultsDiv.innerHTML = `<div class="error">Error: Comparison test failed</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // 언어 선택 변경 시 샘플 프로필 필터링
        document.getElementById('lang-select').addEventListener('change', function() {
            const selectedLang = this.value;
            const sampleSelect = document.getElementById('sample-profile-select');
            const currentValue = sampleSelect.value;
            
            // 해당 언어의 프로필만 표시
            Array.from(sampleSelect.options).forEach(option => {
                if (option.value === 'general') {
                    option.style.display = '';
                } else if (option.dataset.lang === selectedLang) {
                    option.style.display = '';
                } else {
                    option.style.display = 'none';
                }
            });
            
            // 현재 선택된 프로필이 다른 언어면 일반으로 변경
            const currentOption = sampleSelect.querySelector(`option[value="${currentValue}"]`);
            if (currentValue !== 'general' && currentOption && currentOption.dataset.lang !== selectedLang) {
                sampleSelect.value = 'general';
            }
        });
        
        // 페이지 로드 시 사용자 목록 로드
        loadUsers();
    </script>
</body>
</html>
